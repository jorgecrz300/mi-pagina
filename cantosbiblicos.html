<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cantos BÃ­blicos CatÃ³licos</title>
    <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { --naranja: #d35400; --fondo: #fdfaf6; --marron: #5d4037; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--fondo); margin: 0; padding: 20px; text-align: center; color: var(--marron); }
        
        /* TÃ­tulo Elegante */
        h1 { color: var(--naranja); font-size: 24px; text-transform: uppercase; border-bottom: 2px solid var(--naranja); display: inline-block; padding-bottom: 5px; }

        /* Cuadro de Frases BÃ­blicas */
        #cuadro-frase { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin: 20px auto; max-width: 450px; font-style: italic; border-left: 5px solid var(--naranja); }

        /* Botones de AcciÃ³n (Cuadrados) */
        .contenedor-botones { display: flex; justify-content: center; gap: 20px; margin: 20px 0; }
        .btn-cuadrado { 
            background: white; width: 120px; height: 120px; border-radius: 20px; border: 3px dashed var(--naranja);
            display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .btn-cuadrado:active { transform: scale(0.9); }
        .plus { font-size: 40px; color: var(--naranja); font-weight: bold; }
        .label-btn { font-size: 12px; font-weight: bold; color: var(--marron); }

        /* Resultado del Texto - CENTRADO Y LIMPIO */
        #resultado { 
            width: 100%; max-width: 500px; min-height: 150px; margin: 20px auto; background: white; 
            padding: 20px; border-radius: 15px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
            white-space: pre-wrap; text-align: center; /* AquÃ­ se acomoda en el medio */
            font-size: 18px; color: #333; line-height: 1.6; display: none;
        }

        .status { font-weight: bold; color: #27ae60; margin: 10px 0; }
        
        /* Botones PDF */
        #btn-pdf { background: #27ae60; color: white; border: none; padding: 15px 30px; border-radius: 10px; font-weight: bold; cursor: pointer; display: none; margin: 10px auto; }

        /* SecciÃ³n de Guardados */
        #seccion-guardados { display: none; max-width: 450px; margin: 30px auto; text-align: left; background: #eee; padding: 15px; border-radius: 10px; }
        .item-guardado { background: white; padding: 10px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <h1>Cantos BÃ­blicos CatÃ³licos</h1>

    <div id="cuadro-frase">
        <span id="frase-biblica">"Cargando palabra de Dios..."</span>
    </div>

    <div class="contenedor-botones">
        <label class="btn-cuadrado">
            <span class="plus">+</span>
            <span class="label-btn">TOMAR FOTO</span>
            <input type="file" id="archivo" accept="image/*" capture="environment" style="display:none">
        </label>

        <div class="btn-cuadrado" onclick="mostrarGuardados()">
            <span class="plus">ðŸ“‚</span>
            <span class="label-btn">GUARDADOS</span>
        </div>
    </div>

    <div id="status" class="status"></div>
    
    <div id="resultado"></div>

    <button id="btn-pdf" onclick="crearPDF()">ðŸ’¾ GUARDAR EN PDF</button>

    <div id="seccion-guardados">
        <h3 style="text-align:center; margin-top:0;">ðŸ“‚ Mis PDFs Guardados</h3>
        <div id="lista-pdfs"></div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const archivo = document.getElementById('archivo');
        const status = document.getElementById('status');
        const resultado = document.getElementById('resultado');
        const btnPdf = document.getElementById('btn-pdf');
        let textoFinal = "";

        // 1. Frases BÃ­blicas que cambian al entrar/refresh
        const frases = [
            "Â«El SeÃ±or es mi pastor, nada me falta.Â» (Salmo 23)",
            "Â«Tu palabra es una lÃ¡mpara a mis pies.Â» (Salmo 119)",
            "Â«Canten al SeÃ±or un cÃ¡ntico nuevo.Â» (Salmo 98)",
            "Â«Hagan todo para la gloria de Dios.Â» (1 Cor 10:31)"
        ];
        document.getElementById('frase-biblica').innerText = frases[Math.floor(Math.random() * frases.length)];

        // 2. LÃ³gica para procesar la foto
        archivo.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.innerText = "Iniciando lectura...";
            resultado.style.display = "none";
            btnPdf.style.display = "none";

            Tesseract.recognize(
                file,
                'spa',
                { logger: m => {
                    if(m.status === 'recognizing text') {
                        status.innerText = `Leyendo letra: ${Math.round(m.progress * 100)}%`;
                    }
                }}
            ).then(({ data: { text } }) => {
                status.innerText = "Â¡Lectura exitosa!";
                
                // LIMPIEZA DE TEXTO: Quitamos sÃ­mbolos raros que ensucian la lectura
                textoFinal = text.replace(/[|\\/_Â®Â©â„¢~`^+=<>]/g, "").trim();
                
                resultado.innerText = textoFinal;
                resultado.style.display = "block";
                btnPdf.style.display = "block";
            }).catch(err => {
                status.innerText = "Error al leer. Intenta con mÃ¡s luz.";
                console.error(err);
            });
        });

        // 3. FunciÃ³n para crear PDF y Guardar en la lista
        function crearPDF() {
            const doc = new jsPDF();
            doc.setFont("helvetica", "normal");
            
            // Centrar el texto dentro del PDF
            const lineas = doc.splitTextToSize(textoFinal, 160);
            doc.text(lineas, 105, 30, { align: "center" });

            const nombreArchivo = "Canto_" + Date.now() + ".pdf";
            doc.save(nombreArchivo);

            // Guardar en la memoria local (Guardados)
            let misCantos = JSON.parse(localStorage.getItem('misCantos') || "[]");
            misCantos.push({ nombre: nombreArchivo, contenido: textoFinal });
            localStorage.setItem('misCantos', JSON.stringify(misCantos));
            
            alert("Â¡PDF Guardado!");
            actualizarLista();
        }

        // 4. LÃ³gica de la secciÃ³n de Guardados
        function mostrarGuardados() {
            const sec = document.getElementById('seccion-guardados');
            sec.style.display = (sec.style.display === 'block') ? 'none' : 'block';
            actualizarLista();
        }

        function actualizarLista() {
            const lista = document.getElementById('lista-pdfs');
            const cantos = JSON.parse(localStorage.getItem('misCantos') || "[]");
            lista.innerHTML = cantos.length === 0 ? "No hay cantos guardados." : "";
            
            cantos.forEach((canto, index) => {
                const div = document.createElement('div');
                div.className = 'item-guardado';
                div.innerHTML = `
                    <span>ðŸ“„ ${canto.nombre.substring(0,15)}...</span>
                    <button onclick="descargarDeNuevo(${index})">Bajar</button>
                `;
                lista.appendChild(div);
            });
        }

        function descargarDeNuevo(index) {
            const canto = JSON.parse(localStorage.getItem('misCantos'))[index];
            const doc = new jsPDF();
            const lineas = doc.splitTextToSize(canto.contenido, 160);
            doc.text(lineas, 105, 30, { align: "center" });
            doc.save(canto.nombre);
        }
    </script>
</body>
</html>
